(function( exports, $ ) {
    var api = sedApp.editor;

    $( document ).ready( function (  ) {

        var gmapLazyLoad = function( $this_item , gmapOptions , id ){     //alert("test");

            var request = $.post( $this_item.data("gmapUrl") , gmapOptions);

            request.done( function( response ) {

                if( $('#gmap-iframe-' + id ).length > 0 )
                    $('#gmap-iframe-' + id ).remove();

                var iframe = $('<iframe id="gmap-iframe-' + id + '" frameborder=0 />').appendTo( $('#'+id) );
                iframe.css({'width' : $this_item.data("gmapWidth") + "%" , 'height' :$this_item.data("gmapHeight") + "px" });
                var frame = iframe[0].contentWindow;
                frame.document.open();
                frame.document.write( response );
                frame.document.close();
            });

        };

        $('.sed-gmap-container').livequery(function(){
            var item_data_attr   = [ "address","description","type","width","height","zoom" , "mapTypeControl" , "streetViewControl" , "scrollwheel" , "scaleControl" , "baseUrl" , "moduleUrl" , "panControl" , "overlayColor" ],
                $this_item = $(this) ,
                gmapOptions = {} ,
                id = $(this).attr("id");

            $.each( item_data_attr , function( key , value ){
                var val =  $this_item.data( "gmap" + api.fn.ucfirst( value ) );

                gmapOptions[value] = val;

            });

            gmapOptions.id = id;

            gmapLazyLoad( $this_item , gmapOptions , id );

            $(window).resize( function(){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

            $(this).on("sed.moduleSortableStop sed.moduleResizeStop sedAfterRemoveColumns" , function(){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedChangeModulesLength", function( e , length ){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedChangedSheetWidth", function(){
                if( $(this).parents(".sed-row-boxed").length > 0 ){
                    gmapLazyLoad( $this_item , gmapOptions , id );
                }
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedChangedPageLength", function( e , length ){
                if( ($(this).parents(".sed-row-boxed").length == 0 && length == "wide" ) || ($(this).parents(".sed-row-boxed").length == 1 && length == "boxed" ) ){
                    gmapLazyLoad( $this_item , gmapOptions , id );
                }
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedFirstTimeActivatedTabs", function(){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedFirstTimeActivatedAccordionTabs", function(){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

            $(this).parents(".sed-pb-module-container:first").on( "sedFirstTimeMegamenuActivated", function(){
                gmapLazyLoad( $this_item , gmapOptions , id );
            });

        });
    });

}(sedApp, jQuery));